<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>3D maze</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>

    <script src="js/Three.js"></script>
    <script src="js/Three.min.js"></script>
    <script src="js/cannon.js"></script>
    <script src="js/object.js"></script>
    <script src="js/PointerLockControls.js"></script>
    <script src="js/STLLoader.js"></script>
    <div id="count">Level 1: Press start</div>
    <div id="blocker">


        <div id="nextlevel" style="display:none;">
            <span style="font-size:40px">WON</span>
            <br/>Level 2 loading

        </div>

    </div>

    <div id="blocker">


        <div id="gameover" style="display:none;">
            <span style="font-size:40px">GAMEOVER</span>
            <br/>Level 1 Reloading in 3sec

        </div>

    </div>
    <div id="blocker">

        <div id="instructions">
            <span style="font-size:40px">Click to play</span>
            <br /> (W,A,S,D = Move, SPACE = Jump, MOUSE = Look)
        </div>

    </div>

    <script>
        (function() {
            var script = document.createElement('script');
            script.onload = function() {
                var stats = new Stats();
                document.body.appendChild(stats.dom);
                requestAnimationFrame(function loop() {
                    stats.update();
                    requestAnimationFrame(loop)
                });
            };
            script.src = '//mrdoob.github.io/stats.js/build/stats.min.js';
            document.head.appendChild(script);
        })()
        var sphereShape, sphereBody, world, physicsMaterial, walls = [],
            balls = [],
            ballMeshes = [],
            boxes = [],
            boxMeshes = [];
        let count = 60;
        var interval;

        var camera, scene, renderer;
        var geometry, material, mesh, physicsbody, cubeRef, frameRef;
        var controls, time = Date.now();

        var blocker = document.getElementById('blocker');
        var instructions = document.getElementById('instructions');
        var gameover = document.getElementById('gameover');
        var nextlevel = document.getElementById('nextlevel');

        var havePointerLock = 'pointerLockElement' in document || 'mozPointerLockElement' in document || 'webkitPointerLockElement' in document;

        if (havePointerLock) {

            var element = document.body;
            //if the poiter lock
            var pointerlockchange = function(event) {

                    if (document.pointerLockElement === element || document.mozPointerLockElement === element || document.webkitPointerLockElement === element) {

                        controls.enabled = true;

                        blocker.style.display = 'none';
                        interval = setInterval(function() {
                            document.getElementById('count').innerHTML = "Level 1       TIME:" + count;
                            count--;
                            if (count === 0) {
                                clearInterval(interval);
                                document.getElementById('count').innerHTML = 'GAME OVER';
                                blocker.style.display = '-webkit-box';
                                blocker.style.display = '-moz-box';
                                blocker.style.display = 'box';

                                gameover.style.display = '';
                                controls.enabled = false;
                                let reloader = 3;
                                let relo = setInterval(function() {
                                    reloader--
                                    if (reloader === 0) {
                                        location.reload();
                                    }
                                }, 1000);

                            }

                        }, 1000);


                    } else {
                        clearTimeout(interval);
                        controls.enabled = false;

                        blocker.style.display = '-webkit-box';
                        blocker.style.display = '-moz-box';
                        blocker.style.display = 'box';

                        instructions.style.display = '';

                    }

                }
                // if the poiter denied
            var pointerlockerror = function(event) {
                instructions.style.display = '';
            }

            // Hook pointer lock state change events
            document.addEventListener('pointerlockchange', pointerlockchange, false);
            document.addEventListener('mozpointerlockchange', pointerlockchange, false);
            document.addEventListener('webkitpointerlockchange', pointerlockchange, false);

            document.addEventListener('pointerlockerror', pointerlockerror, false);
            document.addEventListener('mozpointerlockerror', pointerlockerror, false);
            document.addEventListener('webkitpointerlockerror', pointerlockerror, false);

            instructions.addEventListener('click', function(event) {
                instructions.style.display = 'none';

                // Ask the browser to lock the pointer
                element.requestPointerLock = element.requestPointerLock || element.mozRequestPointerLock || element.webkitRequestPointerLock;

                if (/Firefox/i.test(navigator.userAgent)) {

                    var fullscreenchange = function(event) {

                        if (document.fullscreenElement === element || document.mozFullscreenElement === element || document.mozFullScreenElement === element) {

                            document.removeEventListener('fullscreenchange', fullscreenchange);
                            document.removeEventListener('mozfullscreenchange', fullscreenchange);

                            element.requestPointerLock();
                        }

                    }

                    document.addEventListener('fullscreenchange', fullscreenchange, false);
                    document.addEventListener('mozfullscreenchange', fullscreenchange, false);

                    element.requestFullscreen = element.requestFullscreen || element.mozRequestFullscreen || element.mozRequestFullScreen || element.webkitRequestFullscreen;

                    element.requestFullscreen();

                } else {

                    element.requestPointerLock();

                }

            }, false);

        } else {

            instructions.innerHTML = 'Your browser doesn\'t seem to support Pointer Lock API';

        }

        initCannon();
        init();
        animate();

        function initCannon() {
            // Setup our world
            world = new CANNON.World();
            world.quatNormalizeSkip = 0;
            world.quatNormalizeFast = false;

            var solver = new CANNON.GSSolver();

            world.defaultContactMaterial.contactEquationStiffness = 1e9;
            world.defaultContactMaterial.contactEquationRelaxation = 4;

            solver.iterations = 7;
            solver.tolerance = 0.1;
            var split = true;
            if (split)
                world.solver = new CANNON.SplitSolver(solver);
            else
                world.solver = solver;

            world.gravity.set(0, -20, 0);
            world.broadphase = new CANNON.NaiveBroadphase();

            // Create a slippery material (friction coefficient = 0.0)
            physicsMaterial = new CANNON.Material("slipperyMaterial");
            var physicsContactMaterial = new CANNON.ContactMaterial(physicsMaterial, physicsMaterial, 0.0,
                0.3 // frictioncoefficient
                // restitution
            );
            var mass = 7,
                radius = 0.5;
            physicsSphere = new CANNON.Sphere(radius);
            physicsbody = new CANNON.Body({
                mass: mass
            });
            physicsbody.addShape(physicsSphere);
            physicsbody.linearDamping = 0.9;
            world.addBody(physicsbody);


            // We must add the contact materials to the world
            world.addContactMaterial(physicsContactMaterial);


            // Create a sphere
            var mass = 5,
                radius = 1;
            sphereShape = new CANNON.Sphere(radius);
            sphereBody = new CANNON.Body({
                mass: mass
            });
            sphereBody.addShape(sphereShape);
            sphereBody.position.set(-2, 5, 53);
            sphereBody.linearDamping = 0.9;
            world.addBody(sphereBody);

            // Create a plane
            var groundShape = new CANNON.Plane();
            var groundBody = new CANNON.Body({
                mass: 0
            });
            groundBody.addShape(groundShape);
            groundBody.quaternion.setFromAxisAngle(new CANNON.Vec3(1, 0, 0), -Math.PI / 2);
            world.addBody(groundBody);
        }

        function init() {

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            //camera.position.set(-50, 50, 100);


            scene = new THREE.Scene();
            // scene.fog = new THREE.Fog("rgb(167, 226, 221)", 0, 50 );

            var ambient = new THREE.AmbientLight("rgb(17, 21, 50)");
            scene.add(ambient);
            //scene.add(camera);
            light = new THREE.SpotLight("rgb(222, 170, 156)");
            light.position.set(10, 100, 20);
            light.target.position.set(5, 0, 55);
            if (true) {
                light.castShadow = true;

                light.shadowCameraNear = 20;
                light.shadowCameraFar = 50; //camera.far;
                light.shadowCameraFov = 40;

                light.shadowMapBias = 0.1;
                light.shadowMapDarkness = 0.7;
                light.shadowMapWidth = 2 * 512;
                light.shadowMapHeight = 2 * 512;

                //light.shadowCameraVisible = true;
            }
            scene.add(light);

            const cubeTextureLoader = new THREE.CubeTextureLoader()
            scene.background = cubeTextureLoader.load([
                "Skybox/3/mystic_ft.jpg",
                "Skybox/3/mystic_bk.jpg",
                "Skybox/3/mystic_up.jpg",
                "Skybox/3/mystic_dn.jpg",
                "Skybox/3/mystic_rt.jpg",
                "Skybox/3/mystic_lf.jpg"
            ])

            var sphere = new THREE.SphereGeometry(0.5, 16, 8);
            light1 = new THREE.PointLight(0xff0040, 2, 50);
            light1.add(new THREE.Mesh(sphere, new THREE.MeshBasicMaterial({
                color: 0xff0040
            })));
            scene.add(light1);
            light2 = new THREE.PointLight(0x0040ff, 2, 50);
            light2.add(new THREE.Mesh(sphere, new THREE.MeshBasicMaterial({
                color: 0x0040ff
            })));
            scene.add(light2);
            light3 = new THREE.PointLight(0x80ff80, 2, 50);
            light3.add(new THREE.Mesh(sphere, new THREE.MeshBasicMaterial({
                color: 0x80ff80
            })));
            scene.add(light3);
            light4 = new THREE.PointLight(0xffaa00, 2, 50);
            light4.add(new THREE.Mesh(sphere, new THREE.MeshBasicMaterial({
                color: 0xffaa00
            })));
            scene.add(light4);


            light1.position.x = 0.5;
            light1.position.y = 4;
            light1.position.z = 8;
            light2.position.x = -60;
            light2.position.y = 4;
            light2.position.z = -30;
            light3.position.x = -70;
            light3.position.y = 4;
            light3.position.z = 50;
            light4.position.x = -40;
            light4.position.y = 4;
            light4.position.z = 0;



            controls = new PointerLockControls(camera, sphereBody);
            scene.add(controls.getObject());
            //console.info(controls);




            renderer = new THREE.WebGLRenderer();
            renderer.shadowMapEnabled = true;
            renderer.shadowMapSoft = true;
            renderer.setSize(window.innerWidth, window.innerHeight);
            // renderer.setClearColor( scene.fog.color, 1 );

            document.body.appendChild(renderer.domElement);

            window.addEventListener('resize', onWindowResize, false);


            var x = 1;
            var y = 10;
            var z = 0;
            const geometryIcosa = new THREE.IcosahedronGeometry(0.5, 1);
            const materialGeoIcosa = new THREE.MeshBasicMaterial({
                color: 0xff0080,
                wireframe: true,
                matrixAutoUpdate: false, //allow to update Matric manually
                needsUpdate: true,

            });
            cubeRef = new THREE.Mesh(geometryIcosa, materialGeoIcosa);
            cubeRef.name = "Cube";
            cubeRef.receiveShadow = true;
            scene.add(cubeRef)
            cubeRef.position.set(0, 20, 0);

            const frameIcosa = new THREE.IcosahedronGeometry(0.5, 1);
            const materialframeIcosa = new THREE.MeshBasicMaterial({
                color: 0xffffff,
                matrixAutoUpdate: false, //allow to update Matric manually
                needsUpdate: true
            });
            frameRef = new THREE.Mesh(frameIcosa, materialframeIcosa);
            frameRef.name = "Framecube";
            scene.add(frameRef);
            frameRef.position.set(0, 20, 0);

            var loader = new THREE.TextureLoader();

            loader.load('grass.png', function(texture) {
                texture.wrapS = THREE.RepeatWrapping;
                texture.wrapT = THREE.RepeatWrapping;
                texture.repeat.set(1000, 1000);
                var geometry = new THREE.PlaneGeometry(300, 300, 20, 20);
                var material = new THREE.MeshBasicMaterial({
                    map: texture,
                    // normalMap: texture,
                    overdraw: 0.5
                });
                var plane = new THREE.Mesh(geometry, material);
                plane.rotation.x = -Math.PI / 2;
                plane.position.y = 0.11111;
                scene.add(plane);
            });

            var wall1 = new Box({
                size: {
                    x: x,
                    y: y,
                    z: z + 95
                },
                position: {
                    x: +2,
                    y: 0,
                    z: 2
                }
            });
            var wall2 = new Box({
                size: {
                    x: x + 96,
                    y: y,
                    z: z + 1
                },
                position: {
                    x: -52,
                    y: 0,
                    z: 50
                }
            });
            var wall2 = new Box({
                size: {
                    x: x + 2,
                    y: y,
                    z: z + 1
                },
                position: {
                    x: 1,
                    y: 0,
                    z: 50
                }
            });
            var wall2 = new Box({
                size: {
                    x: x + 5,
                    y: y,
                    z: z + 1
                },
                position: {
                    x: -0.5,
                    y: 0,
                    z: -30
                }
            });
            var wall3 = new Box({
                size: {
                    x: x + 100,
                    y: y,
                    z: z + 1
                },
                position: {
                    x: -50,
                    y: 0,
                    z: -50
                }
            });
            var wall4 = new Box({
                size: {
                    x: x,
                    y: y,
                    z: z + 100
                },
                position: {
                    x: -100,
                    y: 0,
                    z: 0.5
                }
            });

            var wall21 = new Box({
                size: {
                    x: x,
                    y: y,
                    z: z + 16
                },
                position: {
                    x: -4,
                    y: 0,
                    z: 42
                }
            });

            var wall21 = new Box({
                size: {
                    x: x,
                    y: y,
                    z: z + 30
                },
                position: {
                    x: -4,
                    y: 0,
                    z: 15
                }
            });
            var wall21 = new Box({
                size: {
                    x: x,
                    y: y,
                    z: z + 30
                },
                position: {
                    x: -4,
                    y: 0,
                    z: -19
                }
            });
            var wall41 = new Box({
                size: {
                    x: x + 35,
                    y: y,
                    z: z + 1
                },
                position: {
                    x: -27,
                    y: 0,
                    z: 40
                }
            });
            var wall21 = new Box({
                size: {
                    x: x,
                    y: y,
                    z: z + 30
                },
                position: {
                    x: x - 10,
                    y: 0,
                    z: 20
                }
            });
            var wall21 = new Box({
                size: {
                    x: x,
                    y: y,
                    z: z + 91
                },
                position: {
                    x: x - 46,
                    y: 0,
                    z: -5
                }
            });
            var wall21 = new Box({
                size: {
                    x: x + 10,
                    y: y,
                    z: z + 30
                },
                position: {
                    x: x - 81,
                    y: 0,
                    z: 25
                }
            });
            var wall21 = new Box({
                size: {
                    x: x + 10,
                    y: y,
                    z: z + 20
                },
                position: {
                    x: x - 70,
                    y: 0,
                    z: 20
                }
            });
            var wall21 = new Box({
                size: {
                    x: x + 1,
                    y: y,
                    z: z + 30
                },
                position: {
                    x: x - 55,
                    y: 0,
                    z: 25
                }
            });
            var wall2 = new Box({
                size: {
                    x: x + 40,
                    y: y,
                    z: z + 1
                },
                position: {
                    x: -65,
                    y: 0,
                    z: 5
                }
            });
            var wall2 = new Box({
                size: {
                    x: x + 45,
                    y: y,
                    z: z + 1
                },
                position: {
                    x: -76,
                    y: 0,
                    z: 40
                }
            });
            var wall2 = new Box({
                size: {
                    x: x + 45,
                    y: y,
                    z: z + 1
                },
                position: {
                    x: -76,
                    y: 0,
                    z: 0
                }
            });
            var wall2 = new Box({
                size: {
                    x: x + 45,
                    y: y,
                    z: z + 1
                },
                position: {
                    x: -76,
                    y: 0,
                    z: -10
                }
            });
            var wall21 = new Box({
                size: {
                    x: x + 35,
                    y: y,
                    z: z + 30
                },
                position: {
                    x: x - 70,
                    y: 0,
                    z: -20
                }
            });

            var wall2 = new Box({
                size: {
                    x: x + 25,
                    y: y,
                    z: z + 1
                },
                position: {
                    x: -21.5,
                    y: 0,
                    z: 5
                }
            });
            var wall2 = new Box({
                size: {
                    x: x,
                    y: y,
                    z: z + 40
                },
                position: {
                    x: -35,
                    y: 0,
                    z: -14.5
                }
            });
            var wall2 = new Box({
                size: {
                    x: x + 25,
                    y: y,
                    z: z + 1
                },
                position: {
                    x: -21.5,
                    y: 0,
                    z: -34
                }
            });
            var wall2 = new Box({
                size: {
                    x: x + 27,
                    y: y,
                    z: z + 1
                },
                position: {
                    x: -31,
                    y: 0,
                    z: -40
                }
            });
            var wall42 = new Box({
                size: {
                    x: x,
                    y: y,
                    z: z + 16
                },
                position: {
                    x: -9,
                    y: 0,
                    z: -42
                }
            });
            var wall421 = new Box({
                size: {
                    x: x + 20,
                    y: y,
                    z: z + 20
                },
                position: {
                    x: -25,
                    y: 0,
                    z: 23
                }
            });
            var wall422 = new Box({
                size: {
                    x: x + 30,
                    y: y,
                    z: z + 1
                },
                position: {
                    x: -30,
                    y: 0,
                    z: 13.5
                }
            });
            var wall423 = new Box({
                size: {
                    x: x + 1,
                    y: y,
                    z: z + 25
                },
                position: {
                    x: -28,
                    y: 0,
                    z: -15
                }
            });
            var wall424 = new Box({
                size: {
                    x: x + 15,
                    y: y,
                    z: z + 25
                },
                position: {
                    x: -11,
                    y: 0,
                    z: -15
                }
            });
            var wall31 = new Box({
                size: {
                    x: x + 6,
                    y: y,
                    z: z + 1
                },
                position: {
                    x: -31,
                    y: 0,
                    z: -20
                }
            });


        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        var dt = 1 / 60;

        function animate() {

            cubeRef.position.copy(sphereBody.position);
            cubeRef.quaternion.copy(sphereBody.quaternion);
            frameRef.position.copy(sphereBody.position);
            frameRef.quaternion.copy(sphereBody.quaternion);
            requestAnimationFrame(animate);
            if (controls.enabled) {
                world.step(dt);
            }
            if (controls.getObject().position.z <= -49 || controls.getObject().position.x >= 2.6) {
                //location.replace("levelThree.html")
                clearTimeout(interval);
                blocker.style.display = '-webkit-box';
                blocker.style.display = '-moz-box';
                blocker.style.display = 'box';

                nextlevel.style.display = '';
                controls.enabled = false;
                let reloader = 3;
                let relo = setInterval(function() {
                    reloader--
                    if (reloader === 0) {
                        location.replace("levelTwo.html")

                    }
                }, 1000);


            }

            controls.update(Date.now() - time);
            renderer.render(scene, camera);
            time = Date.now();


        }
    </script>
</body>

</html>